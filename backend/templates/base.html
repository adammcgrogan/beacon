{{define "base"}}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beacon â€” {{.Title}}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .sidebar-link.active { background: #27272a; color: #fff; border-right: 2px solid #3b82f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#09090b] text-zinc-400 antialiased flex h-screen overflow-hidden">
    
    <nav class="w-64 bg-[#09090b] border-r border-zinc-800 flex flex-col p-4">
        <div class="flex items-center gap-3 px-2 mb-8">
            <img src="/static/logo_bg.png" alt="Logo" class="w-8 h-8 rounded-lg shadow-lg">
            <span class="text-white font-bold text-lg tracking-tight">Beacon</span>
        </div>
        
        <div class="space-y-1 flex-1">
            {{if .Grants.CanViewDashboard}}
            <a id="nav-dashboard" href="/" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md transition-all hover:text-white hover:bg-zinc-900 {{if eq .ActiveTab "dashboard"}}active{{end}}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v12a2 2 0 01-2 2h-2a2 2 0 01-2-2V6z"></path></svg>
                Dashboard
            </a>
            {{end}}
            {{if .Grants.CanViewConsole}}
            <a id="nav-console" href="/console" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md transition-all hover:text-white hover:bg-zinc-900 {{if eq .ActiveTab "console"}}active{{end}}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Live Console
            </a>
            {{end}}
            {{if .Grants.CanViewPlayers}}
            <a id="nav-players" href="/players" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md transition-all hover:text-white hover:bg-zinc-900 {{if eq .ActiveTab "players"}}active{{end}}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                Players
            </a>
            {{end}}
            {{if .Grants.CanViewWorlds}}
            <a id="nav-worlds" href="/worlds" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md transition-all hover:text-white hover:bg-zinc-900 {{if eq .ActiveTab "worlds"}}active{{end}}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Worlds
            </a>
            {{end}}
            {{if .Grants.CanViewFiles}}
            <a id="nav-files" href="/files" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md transition-all hover:text-white hover:bg-zinc-900 {{if eq .ActiveTab "files"}}active{{end}}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7a2 2 0 012-2h4l2 2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"></path></svg>
                Files
            </a>
            {{end}}
            {{if .Grants.CanViewAccess}}
            <a id="nav-access" href="/access" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md transition-all hover:text-white hover:bg-zinc-900 {{if eq .ActiveTab "access"}}active{{end}}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L15 12l-5.25-5M3 12h12m0 0a9 9 0 1018 0 9 9 0 00-18 0z"></path></svg>
                Access
            </a>
            {{end}}
        </div>

        <div class="pt-4 border-t border-zinc-800">
            <div class="px-3 py-2 text-xs font-semibold text-zinc-500 uppercase">System Status</div>
            <div class="flex items-center gap-2 px-3 py-2 text-sm">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-zinc-300" id="session-user">{{.Session.PlayerName}}</span>
            </div>
            <button id="logout-btn" class="mt-2 w-full text-xs bg-zinc-800 hover:bg-zinc-700 text-zinc-200 border border-zinc-700 px-3 py-2 rounded-lg transition-colors">Logout</button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-8 bg-[#0c0c0e]">
        {{if eq .ActiveTab "dashboard"}}{{template "dashboard" .}}
        {{else if eq .ActiveTab "console"}}{{template "console" .}}
        {{else if eq .ActiveTab "players"}}{{template "players" .}}
        {{else if eq .ActiveTab "worlds"}}{{template "worlds" .}}
        {{else if eq .ActiveTab "files"}}{{template "files" .}}
        {{else if eq .ActiveTab "access"}}{{template "access" .}}{{end}}
    </main>
    <script>
        window.BeaconAuth = {
            session: {
                player_uuid: "{{.Session.PlayerUUID}}",
                player_name: "{{.Session.PlayerName}}",
                expires_at: {{.Session.ExpiresAt}}
            },
            grants: {
                can_view_dashboard: {{.Grants.CanViewDashboard}},
                can_view_console: {{.Grants.CanViewConsole}},
                can_use_console: {{.Grants.CanUseConsole}},
                can_view_players: {{.Grants.CanViewPlayers}},
                can_kick_players: {{.Grants.CanKickPlayers}},
                can_ban_players: {{.Grants.CanBanPlayers}},
                can_view_worlds: {{.Grants.CanViewWorlds}},
                can_manage_worlds: {{.Grants.CanManageWorlds}},
                can_reset_worlds: {{.Grants.CanResetWorlds}},
                can_edit_gamerules: {{.Grants.CanEditGamerules}},
                can_stop_server: {{.Grants.CanStopServer}},
                can_restart_server: {{.Grants.CanRestartServer}},
                can_save_all: {{.Grants.CanSaveAll}},
                can_view_files: {{.Grants.CanViewFiles}},
                can_edit_files: {{.Grants.CanEditFiles}},
                can_delete_files: {{.Grants.CanDeleteFiles}},
                can_download_files: {{.Grants.CanDownloadFiles}},
                can_view_access: {{.Grants.CanViewAccess}},
                can_manage_access: {{.Grants.CanManageAccess}}
            },
            permissions: []
        };

        function applyBasePermissions(grants) {
            const nav = [
                ['nav-dashboard', !!grants.can_view_dashboard],
                ['nav-console', !!grants.can_view_console],
                ['nav-players', !!grants.can_view_players],
                ['nav-worlds', !!grants.can_view_worlds],
                ['nav-files', !!grants.can_view_files],
                ['nav-access', !!grants.can_view_access]
            ];
            nav.forEach(([id, allowed]) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('hidden', !allowed);
            });
            const path = window.location.pathname;
            if (path === '/console' && !grants.can_view_console) window.location.replace('/');
            if (path === '/players' && !grants.can_view_players) window.location.replace('/');
            if (path === '/worlds' && !grants.can_view_worlds) window.location.replace('/');
            if (path.startsWith('/files') && !grants.can_view_files) window.location.replace('/');
            if (path === '/access' && !grants.can_view_access) window.location.replace('/');
            if (path === '/' && !grants.can_view_dashboard) {
                const firstAllowed = nav.find(([_, allowed]) => allowed);
                if (firstAllowed) {
                    const target = document.getElementById(firstAllowed[0])?.getAttribute('href');
                    if (target) window.location.replace(target);
                }
            }
        }

        async function refreshSessionPermissions() {
            try {
                const response = await fetch('/api/session');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.replace('/auth');
                    }
                    return;
                }
                const data = await response.json();
                window.BeaconAuth.session = {
                    player_uuid: data.player_uuid,
                    player_name: data.player_name,
                    expires_at: data.expires_at
                };
                window.BeaconAuth.permissions = data.permissions || [];
                window.BeaconAuth.grants = data.grants || {};
                applyBasePermissions(window.BeaconAuth.grants);
                window.dispatchEvent(new CustomEvent('beacon:permissions', { detail: window.BeaconAuth }));
            } catch (_) {}
        }

        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (_) {}
            window.location.replace('/auth');
        });

        applyBasePermissions(window.BeaconAuth.grants);
        setInterval(refreshSessionPermissions, 10000);
        refreshSessionPermissions();
    </script>

    <div id="global-modal-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden transition-opacity duration-200 opacity-0"></div>
    <div id="global-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] md:w-[400px] bg-[#121214] border border-zinc-800 rounded-xl shadow-2xl z-[100] hidden opacity-0 scale-95 transition-all duration-200 flex flex-col overflow-hidden">
        <div class="p-5 border-b border-zinc-800 bg-[#18181b]">
            <h2 id="global-modal-title" class="text-lg font-bold text-white">Attention</h2>
        </div>
        <div class="p-5 text-sm text-zinc-300">
            <p id="global-modal-message" class="mb-4"></p>
            <input type="text" id="global-modal-input" class="hidden w-full bg-[#09090b] border border-zinc-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500 transition-colors">
        </div>
        <div class="p-4 bg-[#09090b] border-t border-zinc-800 flex justify-end gap-3" id="global-modal-actions">
            <button id="global-modal-cancel" class="px-4 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors hidden">Cancel</button>
            <button id="global-modal-confirm" class="px-4 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white hover:bg-blue-500 transition-colors">OK</button>
        </div>
    </div>

    <script>
        window.customModal = function(type, message, defaultValue = '') {
            return new Promise((resolve) => {
                const backdrop = document.getElementById('global-modal-backdrop');
                const modal = document.getElementById('global-modal');
                const titleEl = document.getElementById('global-modal-title');
                const messageEl = document.getElementById('global-modal-message');
                const inputEl = document.getElementById('global-modal-input');
                const cancelBtn = document.getElementById('global-modal-cancel');
                const confirmBtn = document.getElementById('global-modal-confirm');

                messageEl.textContent = message;
                inputEl.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                inputEl.value = '';

                if (type === 'alert') {
                    titleEl.textContent = 'Alert';
                    confirmBtn.textContent = 'OK';
                    confirmBtn.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white hover:bg-blue-500 transition-colors';
                } else if (type === 'confirm') {
                    titleEl.textContent = 'Confirmation Required';
                    cancelBtn.classList.remove('hidden');
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-amber-600 text-white hover:bg-amber-500 transition-colors';
                } else if (type === 'prompt') {
                    titleEl.textContent = 'Input Required';
                    cancelBtn.classList.remove('hidden');
                    inputEl.classList.remove('hidden');
                    inputEl.value = defaultValue;
                    confirmBtn.textContent = 'Submit';
                    confirmBtn.className = 'px-4 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white hover:bg-blue-500 transition-colors';
                }

                backdrop.classList.remove('hidden');
                modal.classList.remove('hidden');
                setTimeout(() => { backdrop.classList.remove('opacity-0'); modal.classList.remove('opacity-0', 'scale-95'); if (type === 'prompt') inputEl.focus(); }, 10);

                const cleanup = () => {
                    backdrop.classList.add('opacity-0'); modal.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => { backdrop.classList.add('hidden'); modal.classList.add('hidden'); }, 200);
                };

                confirmBtn.onclick = () => { cleanup(); resolve(type === 'prompt' ? inputEl.value : true); };
                cancelBtn.onclick = () => { cleanup(); resolve(type === 'prompt' ? null : false); };
                inputEl.onkeydown = (e) => { if (e.key === 'Enter') confirmBtn.click(); if (e.key === 'Escape') cancelBtn.click(); };
            });
        };
        window.beaconAlert = (msg) => window.customModal('alert', msg);
        window.beaconConfirm = (msg) => window.customModal('confirm', msg);
        window.beaconPrompt = (msg, def = '') => window.customModal('prompt', msg, def);
    </script>
</body>
</html>
{{end}}
