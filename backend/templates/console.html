{{define "console"}}
    <h1>Live Console</h1>
    
    <div style="margin-bottom: 10px;">
        <input type="text" id="search-input" autocomplete="off" placeholder="ðŸ” Search logs..." style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-family: monospace; box-sizing: border-box;">
    </div>

    <div style="position: relative; margin-bottom: 15px;">
        <div id="logs-container" style="height: 65vh; overflow-y: auto; background: #000; padding: 15px; border-radius: 5px; font-family: monospace; padding-bottom: 40px;"></div>
        
        <button id="new-msg-btn" style="display: none; position: absolute; bottom: 20px; right: 30px; background: #569cd6; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.4);">
            â†“ New Messages
        </button>
    </div>

    <div style="display: flex; gap: 10px;">
        <input type="text" id="cmd-input" autocomplete="off" placeholder="Enter command..." style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-family: monospace;">
        <button id="cmd-btn" style="padding: 10px 20px; background: #569cd6; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Send</button>
    </div>

    <script>
        const logsContainer = document.getElementById('logs-container');
        const input = document.getElementById('cmd-input');
        const btn = document.getElementById('cmd-btn');
        const newMsgBtn = document.getElementById('new-msg-btn');
        const searchInput = document.getElementById('search-input'); // NEW
        const ws = new WebSocket('ws://' + window.location.host + '/ws/web');

        let commandHistory = [];
        let historyIndex = -1;

        ws.onopen = () => appendLog('[SYSTEM]: Connected to Go Backend...', 'INFO');
        ws.onclose = () => appendLog('[SYSTEM]: Disconnected from server.', 'ERROR');

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.event === 'console_log') {
                appendLog(data.payload.message, data.payload.level);
            }
        };

        function sendCommand() {
            const cmd = input.value.trim();
            if (cmd && ws.readyState === WebSocket.OPEN) {
                appendLog('> ' + cmd, 'INFO');
                commandHistory.push(cmd);
                historyIndex = commandHistory.length;

                ws.send(JSON.stringify({
                    event: 'console_command',
                    command: cmd
                }));
                
                input.value = ''; 
                scrollToBottom();
            }
        }

        btn.addEventListener('click', sendCommand);
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendCommand();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault(); 
                if (commandHistory.length > 0 && historyIndex > 0) {
                    historyIndex--;
                    input.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    input.value = commandHistory[historyIndex];
                } else if (historyIndex === commandHistory.length - 1) {
                    historyIndex++;
                    input.value = '';
                }
            }
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            const logs = logsContainer.children;
            
            for (let i = 0; i < logs.length; i++) {
                const log = logs[i];
                if (log.textContent.toLowerCase().includes(query)) {
                    log.style.display = ''; // Show
                } else {
                    log.style.display = 'none'; // Hide
                }
            }
            
            scrollToBottom(); 
        });

        function isAtBottom() {
            return logsContainer.scrollHeight - logsContainer.scrollTop - logsContainer.clientHeight <= 50;
        }

        function scrollToBottom() {
            logsContainer.scrollTop = logsContainer.scrollHeight;
            newMsgBtn.style.display = 'none';
        }

        logsContainer.addEventListener('scroll', () => {
            if (isAtBottom()) {
                newMsgBtn.style.display = 'none';
            }
        });

        newMsgBtn.addEventListener('click', scrollToBottom);

        function appendLog(message, levelClass) {
            const div = document.createElement('div');
            
            if (levelClass === 'ERROR' || levelClass === 'FATAL') div.style.color = '#f44747';
            else if (levelClass === 'WARN') div.style.color = '#ce9178';
            else div.style.color = '#b5cea8';
            
            div.textContent = message;
            
            const query = searchInput.value.toLowerCase();
            if (query && !message.toLowerCase().includes(query)) {
                div.style.display = 'none';
            }
            
            const wasAtBottom = isAtBottom();
            logsContainer.appendChild(div);

            if (div.style.display !== 'none') {
                if (wasAtBottom) {
                    scrollToBottom();
                } else {
                    newMsgBtn.style.display = 'block';
                }
            }
        }
    </script>
{{end}}