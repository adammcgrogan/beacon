{{define "console"}}
    <div class="flex justify-between items-end mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white">Live Console</h1>
            <p id="console-status" class="text-zinc-500 text-sm">Waiting for plugin connection...</p>
        </div>
        
        <div class="flex items-center gap-2">
            <div class="flex bg-[#121214] border border-zinc-800 rounded-lg p-0.5 gap-0.5 shadow-sm">
                <button id="filter-info" onclick="toggleLogFilter('INFO')" 
                    class="px-2.5 py-1 rounded-md text-[11px] font-bold text-white hover:bg-zinc-800 transition-all duration-200 active:scale-95 outline-none uppercase tracking-wider">
                    INFO
                </button>
                <button id="filter-warn" onclick="toggleLogFilter('WARN')" 
                    class="px-2.5 py-1 rounded-md text-[11px] font-bold text-amber-500/80 hover:bg-amber-500/5 transition-all duration-200 active:scale-95 outline-none uppercase tracking-wider">
                    WARN
                </button>
                <button id="filter-error" onclick="toggleLogFilter('ERROR')" 
                    class="px-2.5 py-1 rounded-md text-[11px] font-bold text-red-500/80 hover:bg-red-500/5 transition-all duration-200 active:scale-95 outline-none uppercase tracking-wider">
                    ERROR
                </button>
            </div>

            <input type="text" id="search-input" placeholder="Search logs..." 
                class="bg-zinc-900 border border-zinc-800 text-sm px-4 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 w-64 disabled:opacity-50 disabled:cursor-not-allowed">
            
            <button id="share-logs-btn" class="text-xs bg-blue-600/20 text-blue-400 hover:text-white hover:bg-blue-600 border border-blue-600/30 px-3 py-2 rounded-lg transition-all">
                Share Logs
            </button>
            
            <button onclick="clearConsole()" class="text-xs text-zinc-500 hover:text-white border border-zinc-800 px-3 py-2 rounded-lg transition-colors">
                Clear Console
            </button>
        </div>
    </div>

    <div class="relative group">
        <div id="logs-container" class="h-[70vh] overflow-y-auto bg-[#09090b] border border-zinc-800 rounded-xl p-4 mono text-sm leading-relaxed space-y-0.5 shadow-inner"></div>
        
        <button id="new-msg-btn" class="hidden absolute bottom-6 right-6 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 px-4 rounded-full shadow-xl transition-all">
            â†“ New Messages
        </button>
    </div>

    <div class="mt-4 flex gap-2">
        <div id="cmd-input-wrap" class="relative flex-1">
            <div id="completion-popup" class="hidden absolute left-0 right-0 bottom-full mb-2 bg-[#111113] border border-zinc-700 rounded-lg shadow-2xl z-20 overflow-hidden">
                <div class="px-3 py-2 text-[11px] uppercase tracking-wider text-zinc-500 border-b border-zinc-800">Tab Completions</div>
                <div id="completion-list" class="max-h-52 overflow-y-auto py-1"></div>
            </div>
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600 mono">></span>
            <input type="text" id="cmd-input" placeholder="Enter server command..." 
                class="w-full bg-[#18181b] border border-zinc-800 rounded-lg pl-8 pr-4 py-3 text-white mono text-sm focus:outline-none focus:border-zinc-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        </div>
        <button id="cmd-btn" class="bg-white text-black font-bold px-6 py-3 rounded-lg hover:bg-zinc-200 transition-colors">Execute</button>
    </div>

    <script>
        // --- 1. DOM ELEMENTS & STATE ---
        const logsContainer = document.getElementById('logs-container');
        const cmdInputWrap = document.getElementById('cmd-input-wrap');
        const input = document.getElementById('cmd-input');
        const completionPopup = document.getElementById('completion-popup');
        const completionList = document.getElementById('completion-list');
        const searchInput = document.getElementById('search-input');
        const statusEl = document.getElementById('console-status');
        const btn = document.getElementById('cmd-btn');
        const newMsgBtn = document.getElementById('new-msg-btn');
        const shareBtn = document.getElementById('share-logs-btn');
        const ws = new WebSocket('ws://' + window.location.host + '/ws/web');

        let commandHistory = [];
        let historyIndex = -1;
        let pluginOnline = false;
        let pendingTabRequestId = null;
        let completionBaseInput = '';
        let completionCandidates = [];
        let completionIndex = -1;

        // Spam Collapse State
        let lastLogMessage = null;
        let lastLogElement = null;
        let lastLogCount = 1;

        let logFilters = { INFO: true, WARN: true, ERROR: true, SEVERE: true };

        let activeLogFilter = null;

        // --- FILTER LOGIC ---
        function toggleLogFilter(targetLevel) {
            activeLogFilter = (activeLogFilter === targetLevel) ? null : targetLevel;

            const levels = [
                { id: 'INFO', active: 'bg-zinc-800 ring-1 ring-zinc-700' },
                { id: 'WARN', active: 'bg-amber-500/10 ring-1 ring-amber-500/40 text-amber-400' },
                { id: 'ERROR', active: 'bg-red-500/10 ring-1 ring-red-500/40 text-red-400' }
            ];

            levels.forEach(lvl => {
                const btn = document.getElementById(`filter-${lvl.id.toLowerCase()}`);
                const activeClasses = lvl.active.split(' ');

                if (activeLogFilter === lvl.id) {
                    btn.classList.add(...activeClasses);
                    btn.classList.remove('opacity-40', 'grayscale-[50%]');
                } else if (activeLogFilter === null) {
                    btn.classList.remove(...activeClasses, 'opacity-40', 'grayscale-[50%]');
                } else {
                    btn.classList.remove(...activeClasses);
                    btn.classList.add('opacity-40', 'grayscale-[50%]');
                }
            });

            applyFilters();
        }

        function applyFilters() {
            const query = searchInput.value.toLowerCase();
            
            Array.from(logsContainer.children).forEach(log => {
                const level = log.dataset.level || 'INFO';
                const msgText = log.firstElementChild ? log.firstElementChild.textContent.toLowerCase() : log.textContent.toLowerCase();
                
                const matchesSearch = !query || msgText.includes(query);
                
                const matchesLevel = (activeLogFilter === null) || 
                                     (level === activeLogFilter) || 
                                     (activeLogFilter === 'ERROR' && level === 'SEVERE');
                
                log.classList.toggle('hidden', !(matchesSearch && matchesLevel));
            });
        }

        searchInput.oninput = applyFilters;

        // --- 2. UI FUNCTIONS ---
        function setCommandControlsEnabled(enabled) {
            const canUseConsole = !!window.BeaconAuth?.grants?.can_use_console;
            const canSearchConsole = !!window.BeaconAuth?.grants?.can_view_console;
            const finalEnabled = enabled && canUseConsole;

            input.disabled = !enabled;
            searchInput.disabled = !canSearchConsole;
            btn.disabled = !finalEnabled;
            btn.classList.toggle('opacity-50', !finalEnabled);
            btn.classList.toggle('cursor-not-allowed', !finalEnabled);
            input.disabled = !finalEnabled;

            if (!finalEnabled) {
                resetTabCompletionState();
            }
        }

        function setPluginStatus(status) {
            pluginOnline = status === 'online';
            if (pluginOnline) {
                statusEl.textContent = 'Server online.';
                statusEl.className = 'text-emerald-400 text-sm';
            } else {
                statusEl.textContent = 'Server offline. Start your server to enable command execution.';
                statusEl.className = 'text-amber-400 text-sm';
            }
            setCommandControlsEnabled(pluginOnline);
        }

        function appendLog(message, level) {
            const wasAtBottom = logsContainer.scrollHeight - logsContainer.scrollTop - logsContainer.clientHeight <= 100;

            // --- SPAM COLLAPSE LOGIC ---
            if (lastLogMessage === message && lastLogElement) {
                lastLogCount++;
                
                let badge = lastLogElement.querySelector('.spam-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'spam-badge ml-3 px-1.5 py-0.5 text-[12px] font-bold bg-zinc-700/80 text-zinc-300 rounded whitespace-nowrap self-start mt-0.5';
                    lastLogElement.appendChild(badge);
                }
                badge.textContent = `x${lastLogCount}`;

                if (wasAtBottom) logsContainer.scrollTop = logsContainer.scrollHeight;
                return;
            }

            lastLogMessage = message;
            lastLogCount = 1;

            const div = document.createElement('div');
            const color = level === 'ERROR' ? 'text-red-400' : level === 'WARN' ? 'text-amber-300' : 'text-zinc-400';
            div.className = `${color} hover:bg-zinc-900/50 px-1 rounded transition-colors flex justify-between`;
            div.dataset.level = level || 'INFO';

            const textSpan = document.createElement('span');
            textSpan.className = 'break-all';
            textSpan.textContent = message;
            div.appendChild(textSpan);

            lastLogElement = div;
            
            // Apply current search filter
            const query = searchInput.value.toLowerCase();
            const matchesSearch = !query || message.toLowerCase().includes(query);
            const msgLevel = div.dataset.level;
            
            const matchesLevel = (activeLogFilter === null) || 
                                 (msgLevel === activeLogFilter) || 
                                 (activeLogFilter === 'ERROR' && msgLevel === 'SEVERE');
            
            if (!(matchesSearch && matchesLevel)) {
                div.classList.add('hidden');
            }
            
            logsContainer.appendChild(div);

            // Auto-scroll if already at bottom, otherwise show unread badge
            if (wasAtBottom) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
                newMsgBtn.classList.add('hidden');
            } else if (!div.classList.contains('hidden')) {
                newMsgBtn.classList.remove('hidden');
            }
        }

        function clearConsole() { 
            ws.send(JSON.stringify({ event: 'clear_logs' }));
        }

        function resetTabCompletionState() {
            pendingTabRequestId = null;
            completionBaseInput = '';
            completionCandidates = [];
            completionIndex = -1;
            renderCompletionPopup();
        }

        function findCommonPrefix(values) {
            if (!values || values.length === 0) return '';
            let prefix = values[0];
            for (let i = 1; i < values.length; i++) {
                while (!values[i].startsWith(prefix) && prefix.length > 0) {
                    prefix = prefix.slice(0, -1);
                }
                if (!prefix) break;
            }
            return prefix;
        }

        function applyCompletionAtIndex(newIndex) {
            completionIndex = newIndex;
            const candidate = completionCandidates[completionIndex];
            input.value = candidate ? buildCompletedInput(completionBaseInput, candidate) : input.value;
            renderCompletionPopup();
        }

        function buildCompletedInput(baseInput, candidate) {
            if (baseInput.endsWith(' ')) {
                return `${baseInput}${candidate}`;
            }

            const lastSpaceIndex = baseInput.lastIndexOf(' ');
            const tokenStart = lastSpaceIndex + 1;
            const currentToken = baseInput.slice(tokenStart);

            // If the candidate matches the token being typed, replace that token.
            if (currentToken && candidate.toLowerCase().startsWith(currentToken.toLowerCase())) {
                return `${baseInput.slice(0, tokenStart)}${candidate}`;
            }

            // Otherwise this is likely a suggestion for the next argument.
            return `${baseInput} ${candidate}`;
        }

        function requestTabCompletion() {
            if (!pluginOnline || ws.readyState !== WebSocket.OPEN) return;

            const command = input.value;
            if (!command.trim()) return;

            const requestId = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
            pendingTabRequestId = requestId;

            ws.send(JSON.stringify({
                event: 'console_tab_complete',
                request_id: requestId,
                command
            }));
        }

        function handleTabCompletion(reverse = false) {
            const activeCompletionValue = completionIndex >= 0
                ? buildCompletedInput(completionBaseInput, completionCandidates[completionIndex])
                : null;

            if (completionCandidates.length > 0) {
                if (activeCompletionValue && input.value === activeCompletionValue) {
                    const direction = reverse ? -1 : 1;
                    const next = (completionIndex + direction + completionCandidates.length) % completionCandidates.length;
                    applyCompletionAtIndex(next);
                } else {
                    const next = reverse ? completionCandidates.length - 1 : 0;
                    applyCompletionAtIndex(next);
                }
                return;
            }

            resetTabCompletionState();
            requestTabCompletion();
        }

        function renderCompletionPopup() {
            const shouldShow = pluginOnline && completionCandidates.length > 0;
            completionPopup.classList.toggle('hidden', !shouldShow);
            if (!shouldShow) {
                completionList.innerHTML = '';
                return;
            }

            completionList.innerHTML = '';
            let activeRow = null;
            completionCandidates.forEach((candidate, index) => {
                const row = document.createElement('button');
                row.type = 'button';
                row.className = 'w-full text-left px-3 py-1.5 mono text-sm transition-colors';
                if (index === completionIndex) {
                    row.classList.add('bg-blue-500/20', 'text-blue-300');
                    activeRow = row;
                } else {
                    row.classList.add('text-zinc-300', 'hover:bg-zinc-800/80');
                }
                row.textContent = candidate;
                row.addEventListener('mousedown', (event) => {
                    event.preventDefault();
                    applyCompletionAtIndex(index);
                    input.focus();
                });
                completionList.appendChild(row);
            });

            if (activeRow) {
                activeRow.scrollIntoView({ block: 'nearest' });
            }
        }

        // --- 3. EVENT LISTENERS ---
        function executeCommand() {
            if (!pluginOnline) {
                appendLog('[Beacon] Cannot execute command while server is offline.', 'WARN');
                return;
            }
            if (!window.BeaconAuth?.grants?.can_use_console) {
                appendLog('[Beacon] Permission denied.', 'WARN');
                return;
            }

            const cmd = input.value.trim();
            if (cmd) {
                commandHistory.push(cmd);
                historyIndex = commandHistory.length;
                ws.send(JSON.stringify({event: 'console_command', command: cmd}));
                input.value = '';
                resetTabCompletionState();
            }
        }

        btn.onclick = executeCommand;
        
        input.onkeydown = (e) => {
            if (e.key === 'Enter') executeCommand();
            if (e.key === 'Tab') {
                e.preventDefault();
                handleTabCompletion(e.shiftKey);
                return;
            }
            if (e.key === 'ArrowUp' && historyIndex > 0) {
                input.value = commandHistory[--historyIndex];
                resetTabCompletionState();
            }
            if (e.key === 'ArrowDown') {
                input.value = ++historyIndex < commandHistory.length ? commandHistory[historyIndex] : "";
                resetTabCompletionState();
            }
            if (e.key === 'Escape') resetTabCompletionState();
        };

        input.addEventListener('input', () => {
            const activeCompletionValue = completionIndex >= 0
                ? buildCompletedInput(completionBaseInput, completionCandidates[completionIndex])
                : null;
            if (completionCandidates.length > 0 && activeCompletionValue && input.value === activeCompletionValue) {
                return;
            }
            resetTabCompletionState();
        });

        document.addEventListener('mousedown', (event) => {
            if (completionCandidates.length === 0) return;
            if (!cmdInputWrap.contains(event.target)) {
                resetTabCompletionState();
            }
        });

        newMsgBtn.onclick = () => { 
            logsContainer.scrollTop = logsContainer.scrollHeight; 
            newMsgBtn.classList.add('hidden'); 
        };

        shareBtn.onclick = async () => {
            const visibleLogs = Array.from(logsContainer.children).filter(el => !el.classList.contains('hidden'));
            if (visibleLogs.length === 0) {
                alert("No logs to share!");
                return;
            }

            const logText = visibleLogs.map(el => {
                const msg = el.firstElementChild ? el.firstElementChild.textContent : el.textContent;
                const badge = el.querySelector('.spam-badge');
                return badge ? `${msg} [${badge.textContent}]` : msg;
            }).join('\n');

            const originalText = shareBtn.textContent;
            
            shareBtn.textContent = 'Uploading...';
            shareBtn.disabled = true;

            try {
                const response = await fetch('https://api.mclo.gs/1/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `content=${encodeURIComponent(logText)}`
                });

                const data = await response.json();

                if (data.success) {
                    await navigator.clipboard.writeText(data.url);
                    appendLog(`[Beacon] Logs shared successfully! Link copied: ${data.url}`, 'INFO');
                    shareBtn.textContent = 'Copied Link!';
                    shareBtn.classList.replace('text-blue-400', 'text-emerald-400');
                    shareBtn.classList.replace('border-blue-600/30', 'border-emerald-600/30');
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                appendLog(`[Beacon] Failed to share logs: ${error.message}`, 'ERROR');
                shareBtn.textContent = 'Failed';
            } finally {
                setTimeout(() => {
                    shareBtn.textContent = originalText;
                    shareBtn.disabled = false;
                    shareBtn.className = 'text-xs bg-blue-600/20 text-blue-400 hover:text-white hover:bg-blue-600 border border-blue-600/30 px-3 py-2 rounded-lg transition-all';
                }, 3000);
            }
        };

        // --- 4. WEBSOCKET HANDLERS ---
        ws.onopen = () => ws.send(JSON.stringify({ event: 'plugin_status_request' }));

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.event === 'console_log') appendLog(data.payload.message, data.payload.level);
            if (data.event === 'plugin_status') setPluginStatus(data.payload.status);
            if (data.event === 'command_rejected') appendLog('[Beacon] Command rejected: plugin is offline.', 'WARN');
            if (data.event === 'permission_denied') appendLog('[Beacon] Permission denied.', 'WARN');
            if (data.event === 'console_tab_complete_result') {
                const payload = data.payload || {};
                if (payload.request_id !== pendingTabRequestId) return;

                pendingTabRequestId = null;
                completionBaseInput = input.value;
                completionCandidates = Array.isArray(payload.completions) ? payload.completions : [];
                completionIndex = -1;
                renderCompletionPopup();

                if (completionCandidates.length === 0) return;

                if (completionCandidates.length === 1) {
                    completionIndex = 0;
                    input.value = buildCompletedInput(completionBaseInput, completionCandidates[0]);
                    renderCompletionPopup();
                    return;
                }

                const commonPrefix = findCommonPrefix(completionCandidates);
                if (commonPrefix) {
                    const expandedValue = buildCompletedInput(completionBaseInput, commonPrefix);
                    if (expandedValue.length > completionBaseInput.length) {
                        input.value = expandedValue;
                        renderCompletionPopup();
                        return;
                    }
                }

                if (completionCandidates.length > 0) {
                    applyCompletionAtIndex(0);
                } else {
                    resetTabCompletionState();
                }
            }
            if (data.event === 'clear_logs') {
                logsContainer.innerHTML = '';
                lastLogMessage = null;
                lastLogElement = null;
                lastLogCount = 1;
            }
        };
        
        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ event: 'plugin_status_request' }));
        }, 2000);

        // Init UI state
        setCommandControlsEnabled(false);
        window.addEventListener('beacon:permissions', () => setCommandControlsEnabled(pluginOnline));
    </script>
{{end}}
