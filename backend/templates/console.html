{{define "console"}}
    <div class="flex justify-between items-end mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white">Live Console</h1>
            <p id="console-status" class="text-zinc-500 text-sm">Waiting for plugin connection...</p>
        </div>
        <div class="flex gap-2">
            <input type="text" id="search-input" placeholder="Search logs..." 
                class="bg-zinc-900 border border-zinc-800 text-sm px-4 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 w-64">
            <button onclick="clearConsole()" class="text-xs text-zinc-500 hover:text-white border border-zinc-800 px-3 py-2 rounded-lg transition-colors">Clear</button>
        </div>
    </div>

    <div class="relative group">
        <div id="logs-container" class="h-[70vh] overflow-y-auto bg-[#09090b] border border-zinc-800 rounded-xl p-4 mono text-sm leading-relaxed space-y-0.5 shadow-inner"></div>
        
        <button id="new-msg-btn" class="hidden absolute bottom-6 right-6 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 px-4 rounded-full shadow-xl transition-all">
            â†“ New Messages
        </button>
    </div>

    <div class="mt-4 flex gap-2">
        <div class="relative flex-1">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-600 mono">></span>
            <input type="text" id="cmd-input" placeholder="Enter server command..." 
                class="w-full bg-[#18181b] border border-zinc-800 rounded-lg pl-8 pr-4 py-3 text-white mono text-sm focus:outline-none focus:border-zinc-600 transition-colors">
        </div>
        <button id="cmd-btn" class="bg-white text-black font-bold px-6 py-3 rounded-lg hover:bg-zinc-200 transition-colors">Execute</button>
    </div>

    <script>
        const logsContainer = document.getElementById('logs-container');
        const input = document.getElementById('cmd-input');
        const searchInput = document.getElementById('search-input');
        const statusEl = document.getElementById('console-status');
        const btn = document.getElementById('cmd-btn');
        const newMsgBtn = document.getElementById('new-msg-btn');
        const ws = new WebSocket('ws://' + window.location.host + '/ws/web');

        let commandHistory = [];
        let historyIndex = -1;
        let pluginOnline = false;

        function setCommandControlsEnabled(enabled) {
            input.disabled = !enabled;
            btn.disabled = !enabled;
            btn.classList.toggle('opacity-50', !enabled);
            btn.classList.toggle('cursor-not-allowed', !enabled);
        }

        function setPluginStatus(status) {
            pluginOnline = status === 'online';
            if (pluginOnline) {
                statusEl.textContent = 'Server online.';
                statusEl.className = 'text-emerald-400 text-sm';
            } else {
                statusEl.textContent = 'Server offline. Start your server to enable command execution.';
                statusEl.className = 'text-amber-400 text-sm';
            }
            setCommandControlsEnabled(pluginOnline);
        }

        function appendLog(message, level) {
            const div = document.createElement('div');
            const color = level === 'ERROR' ? 'text-red-400' : level === 'WARN' ? 'text-amber-300' : 'text-zinc-400';
            div.className = `${color} hover:bg-zinc-900/50 px-1 rounded transition-colors`;
            div.textContent = message;
            
            const query = searchInput.value.toLowerCase();
            if (query && !message.toLowerCase().includes(query)) div.classList.add('hidden');
            
            const wasAtBottom = logsContainer.scrollHeight - logsContainer.scrollTop - logsContainer.clientHeight <= 100;
            logsContainer.appendChild(div);

            if (wasAtBottom) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
                newMsgBtn.classList.add('hidden');
            } else if (!div.classList.contains('hidden')) {
                newMsgBtn.classList.remove('hidden');
            }
        }

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.event === 'console_log') appendLog(data.payload.message, data.payload.level);
            if (data.event === 'plugin_status') setPluginStatus(data.payload.status);
            if (data.event === 'command_rejected') appendLog('[Beacon] Command rejected: plugin is offline.', 'WARN');
        };
        ws.onopen = () => {
            ws.send(JSON.stringify({ event: 'plugin_status_request' }));
        };

        function execute() {
            if (!pluginOnline) {
                appendLog('[Beacon] Cannot execute command while plugin is offline.', 'WARN');
                return;
            }

            const cmd = input.value.trim();
            if (cmd) {
                appendLog(`> ${cmd}`, 'INFO');
                commandHistory.push(cmd);
                historyIndex = commandHistory.length;
                ws.send(JSON.stringify({event: 'console_command', command: cmd}));
                input.value = '';
            }
        }

        btn.onclick = execute;
        input.onkeydown = (e) => {
            if (e.key === 'Enter') execute();
            if (e.key === 'ArrowUp' && historyIndex > 0) input.value = commandHistory[--historyIndex];
            if (e.key === 'ArrowDown') input.value = ++historyIndex < commandHistory.length ? commandHistory[historyIndex] : "";
        };

        searchInput.oninput = () => {
            const query = searchInput.value.toLowerCase();
            Array.from(logsContainer.children).forEach(log => {
                log.classList.toggle('hidden', query && !log.textContent.toLowerCase().includes(query));
            });
        };

        function clearConsole() { logsContainer.innerHTML = ''; }
        newMsgBtn.onclick = () => { logsContainer.scrollTop = logsContainer.scrollHeight; newMsgBtn.classList.add('hidden'); };

        setCommandControlsEnabled(false);

        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ event: 'plugin_status_request' }));
            }
        }, 2000);
    </script>
{{end}}