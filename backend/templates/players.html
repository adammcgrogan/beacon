{{define "players"}}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 id="player-count" style="margin: 0;">Players Online ({{.Stats.Players}} / {{.Stats.MaxPlayers}})</h1>
        <input type="text" id="player-search" autocomplete="off" placeholder="ðŸ” Search players..." 
               style="width: 300px; padding: 10px; border-radius: 5px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-family: monospace;">
    </div>
    
    <div style="background: #1e1e1e; border-radius: 8px; border: 1px solid #333; overflow: hidden; max-width: 1000px;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="background: #2d2d2d; border-bottom: 2px solid #444; cursor: pointer;">
                    <th style="padding: 15px;">Head</th>
                    <th onclick="setSort('name')" style="padding: 15px;">Name â†•</th>
                    <th onclick="setSort('ping')" style="padding: 15px;">Ping â†•</th>
                    <th onclick="setSort('playtime')" style="padding: 15px;">Playtime â†•</th>
                    <th style="padding: 15px;">World</th>
                </tr>
            </thead>
            <tbody id="player-table-body">
                </tbody>
        </table>
    </div>

    <script>
        const tbody = document.getElementById('player-table-body');
        const countHeader = document.getElementById('player-count');
        const searchInput = document.getElementById('player-search');
        const ws = new WebSocket('ws://' + window.location.host + '/ws/web');

        let lastPlayerData = [];
        let sortKey = 'name';
        let sortAsc = true;

        function setSort(key) {
            if (sortKey === key) sortAsc = !sortAsc;
            else { sortKey = key; sortAsc = true; }
            renderPlayers();
        }

        function formatPlaytime(ticks) {
            const totalSeconds = ticks / 20;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function renderPlayers() {
            const query = searchInput.value.toLowerCase();
            
            let filtered = lastPlayerData.filter(p => 
                p.name.toLowerCase().includes(query) || p.uuid.toLowerCase().includes(query)
            );

            // Sorting logic
            filtered.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (valA < valB) return sortAsc ? -1 : 1;
                if (valA > valB) return sortAsc ? 1 : -1;
                return 0;
            });

            tbody.innerHTML = '';
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #888;">No players found.</td></tr>';
                return;
            }

            filtered.forEach(p => {
                const row = `
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding: 10px 15px;">
                            <img src="https://mc-heads.net/avatar/${p.uuid}/32" alt="${p.name}" style="border-radius: 4px; width: 32px; height: 32px;">
                        </td>
                        <td style="padding: 10px 15px; font-weight: bold; color: #569cd6;">${p.name}</td>
                        <td style="padding: 10px 15px; color: #b5cea8;">${p.ping} ms</td>
                        <td style="padding: 10px 15px; color: #ce9178;">${formatPlaytime(p.playtime)}</td>
                        <td style="padding: 10px 15px; color: #888; font-size: 0.9em;">${p.world}</td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.event === 'server_stats') {
                lastPlayerData = data.payload.player_list || [];
                countHeader.textContent = `Players Online (${data.payload.players} / ${data.payload.max_players})`;
                renderPlayers();
            }
        };

        searchInput.addEventListener('input', renderPlayers);
    </script>
{{end}}