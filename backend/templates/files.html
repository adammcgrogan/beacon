{{define "files"}}
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-white">File Manager</h1>
        <p id="files-status-subtitle" class="text-zinc-500 text-sm">Browse, edit, delete, and download files.</p>
    </div>

    <div id="path-breadcrumbs" class="mb-4 text-sm text-zinc-400 flex flex-wrap gap-2 items-center"></div>

    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4 h-[72vh]">
        
        <div class="bg-[#18181b] border border-zinc-800 rounded-xl overflow-hidden flex flex-col">
            <div class="px-4 py-2 border-b border-zinc-800 flex justify-between items-center bg-[#1c1c20] min-h-[44px]">
                <span class="text-xs uppercase tracking-wider text-zinc-500 font-semibold">Directory</span>
                
                <div class="flex items-center gap-4">
                    <div id="create-group" class="relative group transition-opacity">
                        <button class="flex items-center gap-1.5 text-zinc-400 hover:text-white transition-colors text-xs font-medium focus:outline-none">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Create
                        </button>
                        <div class="absolute right-0 top-full pt-2 hidden group-hover:block z-50">
                            <div class="bg-[#1f1f23] border border-zinc-700 rounded-lg shadow-xl min-w-[130px] py-1 overflow-hidden">
                                <button onclick="promptCreate('file')" class="w-full text-left px-3 py-2 hover:bg-zinc-700/50 text-xs text-zinc-300 hover:text-white flex items-center gap-2 transition-colors">
                                    <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                    File
                                </button>
                                <button onclick="promptCreate('dir')" class="w-full text-left px-3 py-2 hover:bg-zinc-700/50 text-xs text-zinc-300 hover:text-white flex items-center gap-2 transition-colors">
                                    <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                    Folder
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="upload-group" class="relative group transition-opacity">
                        <button class="flex items-center gap-1.5 text-zinc-400 hover:text-white transition-colors text-xs font-medium focus:outline-none">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            Upload
                        </button>
                        <div class="absolute right-0 top-full pt-2 hidden group-hover:block z-50">
                            <div class="bg-[#1f1f23] border border-zinc-700 rounded-lg shadow-xl min-w-[130px] py-1 overflow-hidden">
                                <button onclick="document.getElementById('file-upload').click()" class="w-full text-left px-3 py-2 hover:bg-zinc-700/50 text-xs text-zinc-300 hover:text-white flex items-center gap-2 transition-colors">
                                    <svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                    File
                                </button>
                                <button onclick="document.getElementById('folder-upload').click()" class="w-full text-left px-3 py-2 hover:bg-zinc-700/50 text-xs text-zinc-300 hover:text-white flex items-center gap-2 transition-colors">
                                    <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                                    Folder
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <input type="file" id="file-upload" class="hidden" multiple onchange="handleUpload(event)">
                <input type="file" id="folder-upload" class="hidden" webkitdirectory directory multiple onchange="handleUpload(event)">
            </div>
            <div id="file-list" class="overflow-y-auto flex-1"></div>
        </div>

        <div class="bg-[#18181b] border border-zinc-800 rounded-xl overflow-hidden flex flex-col">
            <div class="px-4 py-2 border-b border-zinc-800 flex justify-between items-center bg-[#1c1c20] min-h-[44px]">
                <div id="editor-header" class="text-sm text-zinc-400 truncate pr-4">Select a file to edit.</div>
                
                <div class="flex items-center gap-2 shrink-0">
                    <button id="save-btn" class="flex items-center gap-1.5 bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500 hover:text-white px-3 py-1.5 rounded-lg transition-colors text-xs font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Save
                    </button>
                    <button id="download-btn" class="flex items-center gap-1.5 bg-zinc-800 text-zinc-300 border border-zinc-700 hover:bg-zinc-700 hover:text-white px-3 py-1.5 rounded-lg transition-colors text-xs font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Download
                    </button>
                    <button id="delete-btn" class="flex items-center gap-1.5 bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500 hover:text-white px-3 py-1.5 rounded-lg transition-colors text-xs font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        Delete
                    </button>
                </div>
            </div>

            <div id="editor" class="flex-1"></div>
            <div id="editor-offline" class="hidden flex-1 flex items-center justify-center text-zinc-600 italic">Server offline.</div>
            <div id="status-bar" class="px-4 py-2 border-t border-zinc-800 text-xs text-zinc-500">Ready.</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/loader.min.js"></script>
    <script>
        const fileList = document.getElementById('file-list');
        const breadcrumbEl = document.getElementById('path-breadcrumbs');
        const editorHeader = document.getElementById('editor-header');
        const statusBar = document.getElementById('status-bar');
        
        const saveBtn = document.getElementById('save-btn');
        const downloadBtn = document.getElementById('download-btn');
        const deleteBtn = document.getElementById('delete-btn');
        
        const createGroup = document.getElementById('create-group');
        const uploadGroup = document.getElementById('upload-group');

        let editor = null;
        let loadedPath = '';
        let isDirectory = true;
        let pluginOnline = false;

        const ws = new WebSocket('ws://' + window.location.host + '/ws/web');
        ws.onopen = () => ws.send(JSON.stringify({ event: 'plugin_status_request' }));
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.event === 'plugin_status') {
                const wasOffline = !pluginOnline;
                pluginOnline = data.payload.status === 'online';
                
                const statusSubtitle = document.getElementById('files-status-subtitle');
                if (!pluginOnline) {
                    statusSubtitle.textContent = 'Server offline. Start your server to manage files.';
                    statusSubtitle.className = 'text-amber-400 text-sm';
                    fileList.innerHTML = '<div class="px-4 py-10 text-center text-zinc-600 italic">Server offline.</div>';
                    editorHeader.textContent = 'Server offline.';
                    
                    document.getElementById('editor').classList.add('hidden');
                    document.getElementById('editor-offline').classList.remove('hidden');

                    if (editor) editor.setValue('');
                    updateButtons();
                } else {
                    statusSubtitle.textContent = 'Browse, edit, delete, and download files.';
                    statusSubtitle.className = 'text-zinc-500 text-sm';

                    document.getElementById('editor').classList.remove('hidden');
                    document.getElementById('editor-offline').classList.add('hidden');
                    if (editor) setTimeout(() => editor.layout(), 10);

                    if (wasOffline && fileList.innerHTML.includes('Server offline.')) {
                        hydrate(getRoutePath());
                    }
                    updateButtons();
                }
            }
        };
        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ event: 'plugin_status_request' }));
            }
        }, 2000);

        function setStatus(msg, isError = false) {
            statusBar.textContent = msg;
            statusBar.className = `px-4 py-2 border-t border-zinc-800 text-xs ${isError ? 'text-red-400' : 'text-zinc-500'}`;
        }

        function getRoutePath() {
            const base = '/files';
            if (window.location.pathname === base) return '';
            if (!window.location.pathname.startsWith(base + '/')) return '';
            const raw = window.location.pathname.slice((base + '/').length);
            if (!raw) return '';
            return raw.split('/').map(decodeURIComponent).join('/');
        }

        function routeForPath(path) {
            if (!path) return '/files';
            return '/files/' + path.split('/').map(encodeURIComponent).join('/');
        }

        function parentPath(path) {
            if (!path) return '';
            const parts = path.split('/');
            parts.pop();
            return parts.join('/');
        }

        function fileIcon(isDir) {
            return isDir
                ? '<svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>'
                : '<svg class="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>';
        }

        function formatSize(bytes) {
            if (typeof bytes !== 'number' || Number.isNaN(bytes)) return '0 B';
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
            return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function updateButtons() {
            // Editor actions
            const hasFileLoaded = !isDirectory && !!loadedPath;
            saveBtn.disabled = !hasFileLoaded || !editor || !pluginOnline;
            downloadBtn.disabled = !hasFileLoaded || !pluginOnline;
            deleteBtn.disabled = !hasFileLoaded || !pluginOnline;
            
            // Directory actions
            if (!pluginOnline) {
                createGroup.classList.add('opacity-50', 'pointer-events-none');
                uploadGroup.classList.add('opacity-50', 'pointer-events-none');
            } else {
                createGroup.classList.remove('opacity-50', 'pointer-events-none');
                uploadGroup.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        function renderBreadcrumbs(path) {
            const parts = path ? path.split('/') : [];
            let html = `<button class="hover:text-white" data-nav="">root</button>`;
            let current = '';
            parts.forEach(part => {
                current = current ? `${current}/${part}` : part;
                html += `<span class="text-zinc-600">/</span><button class="hover:text-white" data-nav="${escapeHtml(current)}">${escapeHtml(part)}</button>`;
            });
            breadcrumbEl.innerHTML = html;
            breadcrumbEl.querySelectorAll('[data-nav]').forEach(btn => {
                btn.onclick = () => navigate(btn.getAttribute('data-nav'));
            });
        }

        async function apiFetch(url, options = {}) {
            const res = await fetch(url, options);
            if (!res.ok) {
                let message = `Request failed (${res.status})`;
                try {
                    const data = await res.json();
                    if (data.error) message = data.error;
                } catch (_) {}
                throw new Error(message);
            }
            return res.json();
        }

        async function loadDirectory(path) {
            const data = await apiFetch(`/api/files/list?path=${encodeURIComponent(path)}`);
            const parent = parentPath(path);

            let rows = '';
            if (path) {
                rows += `<button class="w-full text-left flex items-center gap-2 px-4 py-2 hover:bg-zinc-800/70 border-b border-zinc-800 text-zinc-300" data-nav="${escapeHtml(parent)}">
                    <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    ..
                </button>`;
            }

            if (!data.entries.length) {
                rows += '<div class="px-4 py-6 text-sm text-zinc-500 italic">Directory is empty.</div>';
            } else {
                data.entries.forEach(entry => {
                    rows += `
                        <button class="w-full text-left flex items-center justify-between gap-3 px-4 py-2 hover:bg-zinc-800/70 border-b border-zinc-800 group" data-path="${escapeHtml(entry.path)}" data-isdir="${entry.is_dir}">
                            <span class="flex items-center gap-2 min-w-0">
                                ${fileIcon(entry.is_dir)}
                                <span class="truncate ${entry.is_dir ? 'text-zinc-100' : 'text-zinc-300'}">${escapeHtml(entry.name)}</span>
                            </span>
                            <span class="text-xs text-zinc-600 group-hover:text-zinc-500">${entry.is_dir ? 'dir' : formatSize(entry.size)}</span>
                        </button>
                    `;
                });
            }

            fileList.innerHTML = rows;
            fileList.querySelectorAll('[data-path]').forEach(btn => {
                btn.onclick = () => navigate(btn.getAttribute('data-path'));
            });
            fileList.querySelectorAll('[data-nav]').forEach(btn => {
                btn.onclick = () => navigate(btn.getAttribute('data-nav'));
            });
        }

        async function loadFile(path) {
            const data = await apiFetch(`/api/files/content?path=${encodeURIComponent(path)}`);
            loadedPath = data.path;
            editorHeader.textContent = `${data.path} â€¢ ${formatSize(data.size)}`;
            if (editor) {
                const modelUri = monaco.Uri.file('/' + data.path);
                let model = monaco.editor.getModel(modelUri);
                if (model) {
                    model.setValue(data.content);
                } else {
                    model = monaco.editor.createModel(data.content, undefined, modelUri);
                }
                editor.setModel(model);
            }
            setStatus(`Loaded ${data.name}. Last modified ${data.modified_at}.`);
        }

        async function hydrate(path) {
            if (!pluginOnline) return;
            setStatus('Loading...');
            renderBreadcrumbs(path);
            try {
                const meta = await apiFetch(`/api/files/meta?path=${encodeURIComponent(path)}`);
                isDirectory = meta.is_dir;
                loadedPath = '';

                document.getElementById('editor').classList.remove('hidden');
                document.getElementById('editor-offline').classList.add('hidden');
                if (editor) setTimeout(() => editor.layout(), 10);

                if (isDirectory) {
                    editorHeader.textContent = 'Select a file to edit.';
                    if (editor) editor.setValue('');
                    await loadDirectory(meta.path);
                    setStatus(`Viewing directory: ${meta.path || '/'}`);
                } else {
                    await loadDirectory(parentPath(meta.path));
                    await loadFile(meta.path);
                }
                updateButtons();
            } catch (err) {
                setStatus(err.message, true);
                if (err.message === 'server is offline') {
                    fileList.innerHTML = `<div class="px-4 py-10 text-center text-zinc-600 italic">Server offline.</div>`;
                    editorHeader.textContent = 'Server offline.';
                    document.getElementById('editor').classList.add('hidden');
                    document.getElementById('editor-offline').classList.remove('hidden');
                } else {
                    fileList.innerHTML = `<div class="px-4 py-6 text-sm text-red-400">${escapeHtml(err.message)}</div>`;
                    editorHeader.textContent = 'Unable to load path.';
                    document.getElementById('editor').classList.remove('hidden');
                    document.getElementById('editor-offline').classList.add('hidden');
                    if (editor) setTimeout(() => editor.layout(), 10);
                }
                if (editor) editor.setValue('');
                loadedPath = '';
                isDirectory = true;
                updateButtons();
            }
        }

        function navigate(path) {
            if (!pluginOnline) return;
            window.history.pushState({}, '', routeForPath(path));
            hydrate(path);
        }

        // --- Create / Upload --- //

        async function promptCreate(type) {
            if (!pluginOnline) return;
            
            let currentDir = isDirectory ? loadedPath : parentPath(loadedPath);
            if (currentDir === undefined) currentDir = '';

            const itemName = prompt(`Enter name for new ${type === 'dir' ? 'folder' : 'file'}:`);
            if (!itemName) return;

            const targetPath = currentDir ? `${currentDir}/${itemName}` : itemName;
            
            try {
                setStatus(`Creating ${type}...`);
                await apiFetch('/api/files/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: targetPath, type: type })
                });
                setStatus(`${type === 'dir' ? 'Folder' : 'File'} created successfully.`);
                
                if (type === 'file') {
                    navigate(targetPath);
                } else {
                    hydrate(currentDir);
                }
            } catch (err) {
                setStatus(`Creation failed: ${err.message}`, true);
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleUpload(event) {
            if (!pluginOnline) return;
            
            const files = event.target.files;
            if (!files.length) return;
            
            let currentDir = isDirectory ? loadedPath : parentPath(loadedPath);
            if (currentDir === undefined) currentDir = '';

            setStatus(`Uploading ${files.length} file(s)...`);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const relativePath = file.webkitRelativePath || file.name;
                const targetPath = currentDir ? `${currentDir}/${relativePath}` : relativePath;

                try {
                    const base64Content = await readFileAsBase64(file);
                    
                    await apiFetch(`/api/files/upload`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: targetPath, content: base64Content })
                    });
                } catch (err) {
                    console.error("Upload failed for", file.name, err);
                    setStatus(`Failed to upload ${file.name}: ${err.message}`, true);
                    event.target.value = '';
                    return; 
                }
            }
            
            setStatus(`Successfully uploaded ${files.length} file(s).`);
            event.target.value = ''; 
            hydrate(currentDir); 
        }

        // --- File Actions --- //

        async function saveCurrentFile() {
            if (!editor || !loadedPath || !pluginOnline) return;
            try {
                setStatus('Saving...');
                await apiFetch(`/api/files/content?path=${encodeURIComponent(loadedPath)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: editor.getValue() })
                });
                setStatus('Saved successfully.');
            } catch (err) {
                setStatus(err.message, true);
            }
        }

        function downloadCurrentFile() {
            if (!loadedPath || !pluginOnline) return;
            window.location.href = `/api/files/download?path=${encodeURIComponent(loadedPath)}`;
        }

        async function deleteCurrentFile() {
            if (!loadedPath || !pluginOnline) return;
            if (!confirm(`Delete ${loadedPath}? This action cannot be undone.`)) return;
            try {
                await apiFetch(`/api/files?path=${encodeURIComponent(loadedPath)}`, { method: 'DELETE' });
                const backTo = parentPath(loadedPath);
                window.history.pushState({}, '', routeForPath(backTo));
                await hydrate(backTo);
                setStatus('File deleted.');
            } catch (err) {
                setStatus(err.message, true);
            }
        }

        saveBtn.onclick = saveCurrentFile;
        downloadBtn.onclick = downloadCurrentFile;
        deleteBtn.onclick = deleteCurrentFile;

        document.addEventListener('keydown', (event) => {
            const isSaveCombo = (event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 's';
            if (!isSaveCombo) return;

            event.preventDefault();
            if (!saveBtn.disabled) {
                saveCurrentFile();
            }
        });

        window.onpopstate = () => hydrate(getRoutePath());

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs' } });
        require(['vs/editor/editor.main'], () => {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'plaintext',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                fontFamily: 'JetBrains Mono, monospace',
                fontSize: 13
            });
            
            if (pluginOnline) {
                document.getElementById('editor').classList.remove('hidden');
                document.getElementById('editor-offline').classList.add('hidden');
            } else {
                document.getElementById('editor').classList.add('hidden');
                document.getElementById('editor-offline').classList.remove('hidden');
            }

            hydrate(getRoutePath());
            updateButtons();
        });

        setStatus('Loading Monaco editor...');
        updateButtons();
    </script>
{{end}}