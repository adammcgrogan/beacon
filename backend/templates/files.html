{{define "files"}}
    <div class="flex items-end justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white">File Manager</h1>
            <p id="files-status-subtitle" class="text-zinc-500 text-sm">Browse, edit, delete, and download files.</p>
        </div>
        <div class="flex gap-2">
            <button id="save-btn" class="flex items-center gap-2 bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 text-sm font-medium px-4 py-2 rounded-lg hover:bg-emerald-500 hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                Save
            </button>
            <button id="download-btn" class="flex items-center gap-2 bg-zinc-800/50 text-zinc-300 border border-zinc-700/50 text-sm font-medium px-4 py-2 rounded-lg hover:bg-zinc-800 hover:border-zinc-600 hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Download
            </button>
            <button id="delete-btn" class="flex items-center gap-2 bg-red-500/10 text-red-400 border border-red-500/20 text-sm font-medium px-4 py-2 rounded-lg hover:bg-red-500 hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Delete
            </button>
        </div>
    </div>

    <div id="path-breadcrumbs" class="mb-4 text-sm text-zinc-400 flex flex-wrap gap-2 items-center"></div>

    <div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-4 h-[72vh]">
        <div class="bg-[#18181b] border border-zinc-800 rounded-xl overflow-hidden flex flex-col">
            <div class="px-4 py-2.5 border-b border-zinc-800 flex justify-between items-center text-xs uppercase tracking-wider text-zinc-500">
                <span>Directory</span>
                <div class="flex gap-1">
                    <button id="new-file-btn" class="p-1.5 hover:text-zinc-300 hover:bg-zinc-700 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="New File">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </button>
                    <button id="new-folder-btn" class="p-1.5 hover:text-zinc-300 hover:bg-zinc-700 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="New Folder">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                    </button>
                    <button id="upload-file-btn" class="p-1.5 hover:text-zinc-300 hover:bg-zinc-700 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Upload File">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </button>
                    <button id="upload-folder-btn" class="p-1.5 hover:text-zinc-300 hover:bg-zinc-700 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed relative" title="Upload Folder">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path></svg>
                        <svg class="w-3 h-3 absolute bottom-1 right-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </button>
                    
                    <input type="file" id="file-upload-input" class="hidden" multiple>
                    <input type="file" id="folder-upload-input" class="hidden" webkitdirectory directory multiple>
                </div>
            </div>
            <div id="file-list" class="overflow-y-auto flex-1"></div>
        </div>
        <div class="bg-[#18181b] border border-zinc-800 rounded-xl overflow-hidden flex flex-col">
            <div id="editor-header" class="px-4 py-3 border-b border-zinc-800 text-sm text-zinc-400">Select a file to edit.</div>
            <div id="editor" class="flex-1"></div>
            <div id="editor-offline" class="hidden flex-1 flex items-center justify-center text-zinc-600 italic">Server offline.</div>
            <div id="status-bar" class="px-4 py-2 border-t border-zinc-800 text-xs text-zinc-500">Ready.</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/loader.min.js"></script>
    <script>
        const fileList = document.getElementById('file-list');
        const breadcrumbEl = document.getElementById('path-breadcrumbs');
        const editorHeader = document.getElementById('editor-header');
        const statusBar = document.getElementById('status-bar');
        
        const saveBtn = document.getElementById('save-btn');
        const downloadBtn = document.getElementById('download-btn');
        const deleteBtn = document.getElementById('delete-btn');
        
        const newFileBtn = document.getElementById('new-file-btn');
        const newFolderBtn = document.getElementById('new-folder-btn');
        const uploadFileBtn = document.getElementById('upload-file-btn');
        const uploadFolderBtn = document.getElementById('upload-folder-btn');
        const fileUploadInput = document.getElementById('file-upload-input');
        const folderUploadInput = document.getElementById('folder-upload-input');

        let editor = null;
        let loadedPath = '';
        let isDirectory = true;
        let pluginOnline = false;

        const ws = new WebSocket('ws://' + window.location.host + '/ws/web');
        ws.onopen = () => ws.send(JSON.stringify({ event: 'plugin_status_request' }));
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.event === 'plugin_status') {
                const wasOffline = !pluginOnline;
                pluginOnline = data.payload.status === 'online';
                
                const statusSubtitle = document.getElementById('files-status-subtitle');
                if (!pluginOnline) {
                    statusSubtitle.textContent = 'Server offline. Start your server to view files.';
                    statusSubtitle.className = 'text-amber-400 text-sm';
                    fileList.innerHTML = '<div class="px-4 py-10 text-center text-zinc-600 italic">Server offline.</div>';
                    editorHeader.textContent = 'Server offline.';
                    
                    document.getElementById('editor').classList.add('hidden');
                    document.getElementById('editor-offline').classList.remove('hidden');

                    if (editor) editor.setValue('');
                    updateButtons();
                } else {
                    statusSubtitle.textContent = 'Browse, edit, delete, and download files.';
                    statusSubtitle.className = 'text-zinc-500 text-sm';

                    document.getElementById('editor').classList.remove('hidden');
                    document.getElementById('editor-offline').classList.add('hidden');
                    if (editor) setTimeout(() => editor.layout(), 10);

                    if (wasOffline && (fileList.children.length === 0 || fileList.innerHTML.includes('Server offline.'))) {
                        hydrate(getRoutePath());
                    }
                }
            }
        };
        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ event: 'plugin_status_request' }));
            }
        }, 2000);

        function setStatus(msg, isError = false) {
            statusBar.textContent = msg;
            statusBar.className = `px-4 py-2 border-t border-zinc-800 text-xs ${isError ? 'text-red-400' : 'text-zinc-500'}`;
        }

        function getRoutePath() {
            const base = '/files';
            if (window.location.pathname === base) return '';
            if (!window.location.pathname.startsWith(base + '/')) return '';
            const raw = window.location.pathname.slice((base + '/').length);
            if (!raw) return '';
            return raw.split('/').map(decodeURIComponent).join('/');
        }

        function routeForPath(path) {
            if (!path) return '/files';
            return '/files/' + path.split('/').map(encodeURIComponent).join('/');
        }

        function parentPath(path) {
            if (!path) return '';
            const parts = path.split('/');
            parts.pop();
            return parts.join('/');
        }

        function fileIcon(isDir) {
            return isDir
                ? '<svg class="w-4 h-4 text-amber-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7a2 2 0 012-2h4l2 2h8a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"></path></svg>'
                : '<svg class="w-4 h-4 text-sky-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
        }

        function formatSize(bytes) {
            if (typeof bytes !== 'number' || Number.isNaN(bytes)) return '0 B';
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
            return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function updateButtons() {
            const hasFileLoaded = !isDirectory && !!loadedPath;
            const grants = window.BeaconAuth?.grants || {};
            
            saveBtn.disabled = !hasFileLoaded || !editor || !pluginOnline || !grants.can_edit_files;
            downloadBtn.disabled = !hasFileLoaded || !pluginOnline || !grants.can_download_files;
            deleteBtn.disabled = !hasFileLoaded || !pluginOnline || !grants.can_delete_files;
            
            newFileBtn.disabled = !pluginOnline || !grants.can_edit_files;
            newFolderBtn.disabled = !pluginOnline || !grants.can_edit_files;
            uploadFileBtn.disabled = !pluginOnline || !grants.can_edit_files;
            uploadFolderBtn.disabled = !pluginOnline || !grants.can_edit_files;
        }

        function renderBreadcrumbs(path) {
            const parts = path ? path.split('/') : [];
            let html = `<button class="hover:text-white" data-nav="">root</button>`;
            let current = '';
            parts.forEach(part => {
                current = current ? `${current}/${part}` : part;
                html += `<span class="text-zinc-600">/</span><button class="hover:text-white" data-nav="${escapeHtml(current)}">${escapeHtml(part)}</button>`;
            });
            breadcrumbEl.innerHTML = html;
            breadcrumbEl.querySelectorAll('[data-nav]').forEach(btn => {
                btn.onclick = () => navigate(btn.getAttribute('data-nav'));
            });
        }

        async function apiFetch(url, options = {}) {
            const res = await fetch(url, options);
            if (!res.ok) {
                let message = `Request failed (${res.status})`;
                try {
                    const data = await res.json();
                    if (data.error) message = data.error;
                } catch (_) {}
                throw new Error(message);
            }
            return res.json();
        }

        async function loadDirectory(path) {
            const data = await apiFetch(`/api/files/list?path=${encodeURIComponent(path)}`);
            const parent = parentPath(path);

            let rows = '';
            if (path) {
                rows += `<button class="w-full text-left flex items-center gap-2 px-4 py-2 hover:bg-zinc-800/70 border-b border-zinc-800 text-zinc-300" data-nav="${escapeHtml(parent)}">${fileIcon(true)} ..</button>`;
            }

            if (!data.entries.length) {
                rows += '<div class="px-4 py-6 text-sm text-zinc-500 italic">Directory is empty.</div>';
            } else {
                data.entries.forEach(entry => {
                    const isDir = entry.is_dir;
                    rows += `
                        <div class="w-full text-left flex items-center justify-between gap-3 px-4 py-2 hover:bg-zinc-800/70 border-b border-zinc-800 group cursor-pointer" onclick="if(!event.target.closest('.delete-btn')) navigate('${escapeHtml(entry.path)}')">
                            <span class="flex items-center gap-2 min-w-0">
                                ${fileIcon(isDir)}
                                <span class="truncate ${isDir ? 'text-zinc-100' : 'text-zinc-300'}">${escapeHtml(entry.name)}</span>
                            </span>
                            <span class="text-xs text-zinc-600 group-hover:hidden">${isDir ? 'dir' : formatSize(entry.size)}</span>
                            <button class="delete-btn hidden group-hover:block text-red-400 hover:text-red-300 transition-colors p-1" onclick="deleteEntryFromList(event, '${escapeHtml(entry.path)}', ${isDir})" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                });
            }

            fileList.innerHTML = rows;
            fileList.querySelectorAll('[data-nav]').forEach(btn => {
                btn.onclick = () => navigate(btn.getAttribute('data-nav'));
            });
        }

        window.deleteEntryFromList = async function(event, path, isDir) {
            event.stopPropagation();
            if (!pluginOnline) return;
            const type = isDir ? 'folder' : 'file';
            const confirmed = await window.beaconConfirm(`Delete ${type} "${path}"? This action cannot be undone.`);
            if (!confirmed) return;
            try {
                await apiFetch(`/api/files?path=${encodeURIComponent(path)}`, { method: 'DELETE' });
                setStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted.`);
                if (loadedPath === path) {
                    const backTo = parentPath(path);
                    window.history.pushState({}, '', routeForPath(backTo));
                    await hydrate(backTo);
                } else {
                    await hydrate(getRoutePath());
                }
            } catch (err) {
                setStatus(err.message, true);
            }
        };

        async function loadFile(path) {
            const data = await apiFetch(`/api/files/content?path=${encodeURIComponent(path)}`);
            loadedPath = data.path;
            editorHeader.textContent = `${data.path} â€¢ ${formatSize(data.size)}`;
            if (editor) {
                const modelUri = monaco.Uri.file('/' + data.path);
                let model = monaco.editor.getModel(modelUri);
                if (model) {
                    model.setValue(data.content);
                } else {
                    model = monaco.editor.createModel(data.content, undefined, modelUri);
                }
                editor.setModel(model);
            }
            setStatus(`Loaded ${data.name}. Last modified ${data.modified_at}.`);
        }

        async function hydrate(path) {
            if (!pluginOnline) return;
            setStatus('Loading...');
            renderBreadcrumbs(path);
            try {
                const meta = await apiFetch(`/api/files/meta?path=${encodeURIComponent(path)}`);
                isDirectory = meta.is_dir;
                loadedPath = '';

                document.getElementById('editor').classList.remove('hidden');
                document.getElementById('editor-offline').classList.add('hidden');
                if (editor) setTimeout(() => editor.layout(), 10);

                if (isDirectory) {
                    editorHeader.textContent = 'Select a file to edit.';
                    if (editor) editor.setValue('');
                    await loadDirectory(meta.path);
                    setStatus(`Viewing directory: ${meta.path || '/'}`);
                } else {
                    await loadDirectory(parentPath(meta.path));
                    await loadFile(meta.path);
                }
                updateButtons();
            } catch (err) {
                setStatus(err.message, true);
                if (err.message === 'server is offline') {
                    fileList.innerHTML = `<div class="px-4 py-10 text-center text-zinc-600 italic">Server offline.</div>`;
                    editorHeader.textContent = 'Server offline.';
                    document.getElementById('editor').classList.add('hidden');
                    document.getElementById('editor-offline').classList.remove('hidden');
                } else {
                    fileList.innerHTML = `<div class="px-4 py-6 text-sm text-red-400">${escapeHtml(err.message)}</div>`;
                    editorHeader.textContent = 'Unable to load path.';
                    document.getElementById('editor').classList.remove('hidden');
                    document.getElementById('editor-offline').classList.add('hidden');
                    if (editor) setTimeout(() => editor.layout(), 10);
                }
                if (editor) editor.setValue('');
                loadedPath = '';
                isDirectory = true;
                updateButtons();
            }
        }

        function navigate(path) {
            if (!pluginOnline) return;
            window.history.pushState({}, '', routeForPath(path));
            hydrate(path);
        }

        async function saveCurrentFile() {
            if (!editor || !loadedPath || !pluginOnline) return;
            try {
                setStatus('Saving...');
                await apiFetch(`/api/files/content?path=${encodeURIComponent(loadedPath)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: editor.getValue() })
                });
                setStatus('Saved successfully.');
            } catch (err) {
                setStatus(err.message, true);
            }
        }

        function downloadCurrentFile() {
            if (!loadedPath || !pluginOnline) return;
            window.location.href = `/api/files/download?path=${encodeURIComponent(loadedPath)}`;
        }

        async function deleteCurrentFile() {
            if (!loadedPath || !pluginOnline) return;
            const confirmed = await window.beaconConfirm(`Delete ${loadedPath}? This action cannot be undone.`);
            if (!confirmed) return;
            try {
                await apiFetch(`/api/files?path=${encodeURIComponent(loadedPath)}`, { method: 'DELETE' });
                const backTo = parentPath(loadedPath);
                window.history.pushState({}, '', routeForPath(backTo));
                await hydrate(backTo);
                setStatus('File deleted.');
            } catch (err) {
                setStatus(err.message, true);
            }
        }

        saveBtn.onclick = saveCurrentFile;
        downloadBtn.onclick = downloadCurrentFile;
        deleteBtn.onclick = deleteCurrentFile;

        // Toolbar Action Bindings
        newFileBtn.onclick = async () => {
            if (!pluginOnline) return;
            const name = await window.beaconPrompt('Enter new file name:');
            if (!name) return;
            
            // Check if we are currently looking at a file vs. folder
            const currentDir = isDirectory ? getRoutePath() : parentPath(getRoutePath());
            const path = currentDir ? `${currentDir}/${name}` : name;
            
            try {
                await apiFetch(`/api/files/content?path=${encodeURIComponent(path)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: '' })
                });
                navigate(path);
            } catch (e) { setStatus(e.message, true); }
        };

        newFolderBtn.onclick = async () => {
            if (!pluginOnline) return;
            const name = await window.beaconPrompt('Enter new folder name:');
            if (!name) return;
            
            // Check if we are currently looking at a file vs. folder
            const currentDir = isDirectory ? getRoutePath() : parentPath(getRoutePath());
            const path = currentDir ? `${currentDir}/${name}` : name;
            
            try {
                await apiFetch(`/api/files/dir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                hydrate(getRoutePath());
                setStatus('Folder created.');
            } catch (e) { setStatus(e.message, true); }
        };

        uploadFileBtn.onclick = () => { if (pluginOnline) fileUploadInput.click(); };
        uploadFolderBtn.onclick = () => { if (pluginOnline) folderUploadInput.click(); };

        async function handleUploads(files) {
            if (!files.length) return;
            
            // Check if we are currently looking at a file vs. folder
            const currentDir = isDirectory ? getRoutePath() : parentPath(getRoutePath());
            setStatus(`Uploading ${files.length} file(s)...`);
            
            let successCount = 0;
            for (const file of files) {
                const relativePath = file.webkitRelativePath || file.name;
                const path = currentDir ? `${currentDir}/${relativePath}` : relativePath;
                
                await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const base64 = ev.target.result.split(',')[1];
                        try {
                            await apiFetch(`/api/files/upload`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ path, content: base64 })
                            });
                            successCount++;
                        } catch (err) {
                            console.error(`Failed to upload ${relativePath}: ${err.message}`);
                        }
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            hydrate(getRoutePath());
            if (successCount === files.length) {
                setStatus(`Successfully uploaded ${successCount} file(s).`);
            } else {
                setStatus(`Uploaded ${successCount} of ${files.length} file(s). Check console for errors.`, true);
            }
        }

        fileUploadInput.onchange = (e) => {
            handleUploads(e.target.files);
            fileUploadInput.value = '';
        };

        folderUploadInput.onchange = (e) => {
            handleUploads(e.target.files);
            folderUploadInput.value = '';
        };

        document.addEventListener('keydown', (event) => {
            const isSaveCombo = (event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 's';
            if (!isSaveCombo) return;

            event.preventDefault();
            if (!saveBtn.disabled) {
                saveCurrentFile();
            }
        });

        window.onpopstate = () => hydrate(getRoutePath());
        window.addEventListener('beacon:permissions', () => {
            if (!window.BeaconAuth?.grants?.can_view_files) {
                window.location.replace('/');
                return;
            }
            updateButtons();
        });

        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs' } });
        require(['vs/editor/editor.main'], () => {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'plaintext',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                fontFamily: 'JetBrains Mono, monospace',
                fontSize: 13
            });
            
            if (pluginOnline) {
                document.getElementById('editor').classList.remove('hidden');
                document.getElementById('editor-offline').classList.add('hidden');
            } else {
                document.getElementById('editor').classList.add('hidden');
                document.getElementById('editor-offline').classList.remove('hidden');
            }

            hydrate(getRoutePath());
            updateButtons();
        });

        setStatus('Loading Monaco editor...');
        updateButtons();
    </script>
{{end}}